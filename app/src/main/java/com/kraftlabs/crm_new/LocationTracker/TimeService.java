package com.kraftlabs.crm_new.LocationTracker;import android.app.Service;import android.content.Context;import android.content.Intent;import android.content.SharedPreferences;import android.os.Handler;import android.os.IBinder;import android.support.annotation.Nullable;import android.util.Log;import com.android.volley.AuthFailureError;import com.android.volley.DefaultRetryPolicy;import com.android.volley.Request;import com.android.volley.RequestQueue;import com.android.volley.RetryPolicy;import com.android.volley.toolbox.StringRequest;import com.android.volley.toolbox.Volley;import com.kraftlabs.crm_new.Config.Config;import com.kraftlabs.crm_new.Db.DatabaseHelper;import com.kraftlabs.crm_new.LocationTracker.database.LocModel;import com.kraftlabs.crm_new.LocationTracker.database.LocTable;import com.kraftlabs.crm_new.Util.PrefUtils;import java.text.SimpleDateFormat;import java.util.ArrayList;import java.util.Date;import java.util.Hashtable;import java.util.Map;import java.util.Timer;import java.util.TimerTask;import org.json.JSONException;import org.json.JSONObject;/** * User: Ashik * Date: 28-Jul-18 * Time: 3:05 PM */public class TimeService extends Service {    private static final String TAG = TimeService.class.getSimpleName();    private Handler mHandler = new Handler();    // timer handling    private Timer mTimer = null;    public static final long NOTIFY_INTERVAL = 1000 *5;  //  public static final long NOTIFY_INTERVAL = 1000 * 60 * 4;    private DatabaseHelper database;    private LocTable locTable;    private LocModel locModel;    private ArrayList<LocModel> locModelArrayList = new ArrayList<>();    private RequestQueue requestQueue;    private Context context;    public TimeService(Context context) {        super();        this.context = context;        Log.i("HERE", "here I am!");    }    public TimeService() {    }    @Override    public int onStartCommand(Intent intent, int flags, int startId) {        super.onStartCommand(intent, flags, startId);        // startTimer();        Log.i(TAG, "onStartCommand: ");        return START_STICKY;    }    @Override    public void onDestroy() {        super.onDestroy();        mTimer.cancel();        new TimeDisplayTimerTask().cancel();        Log.i(TAG, "onDestroy: ");        Intent broadcastIntent = new Intent(".Services.TrackLocationReciever");        sendBroadcast(broadcastIntent);    }    @Nullable    @Override    public IBinder onBind(Intent intent) {        return null;    }    @Override    public void onCreate() {        locTable = new LocTable(this);        mTimer = new Timer();        mTimer.schedule(new TimeDisplayTimerTask(), 1000                , NOTIFY_INTERVAL);        Log.i(TAG, "onCreate: ");        // schedule task        // mTimer.scheduleAtFixedRate(new TimeDisplayTimerTask(), 0, NOTIFY_INTERVAL);    }    class TimeDisplayTimerTask extends TimerTask {        @Override        public void run() {            // run on another thread            mHandler.post(new Runnable() {                @Override                public void run() {                    // display toast                    sync();                }            });        }        private String getDateTime() {            // get date time in custom format            SimpleDateFormat sdf = new SimpleDateFormat("[yyyy/MM/dd - HH:mm:ss]");            return sdf.format(new Date());        }    }    public void sync() {        try {            locTable = new LocTable(this);        } catch (NullPointerException e) {            locTable = new LocTable(getApplicationContext());        }        locModelArrayList = locTable.getUnsentData();        if (locModelArrayList.size() > 0) {            for (int i = 0; i < locModelArrayList.size(); i++) {                locModel = locModelArrayList.get(i);                sendToServer((int) locModel.getId());            }        }    }    public void sendToServer(final int id) {        StringRequest stringRequest = new StringRequest(Request.Method.POST, Config.SAVE_LOCATION, response -> {            Log.i(TAG, response);            SharedPreferences versionInfoPref = this.getSharedPreferences("AppVersion", MODE_PRIVATE);            String versionName = versionInfoPref.getString("version_name", "0");            try {                JSONObject jsonObject = new JSONObject(response);                String status = jsonObject.getString("status");                if (status.equals("success")) {                    // int localId = jsonObject.getInt("local_id");                    int serverId = jsonObject.getInt("server_id");                    LocModel position = locTable.getPositionById(id);                    position.setServerId(serverId);                    position.setVersionName(versionName);                    locTable.updatePosition(position);                }            } catch (JSONException | NullPointerException e) {                Log.i(TAG, e.getMessage());            }        }, error -> {        }        ) {            protected Map<String, String> getParams() throws AuthFailureError {                Map<String, String> params = new Hashtable<String, String>();                int userId = PrefUtils.getCurrentUserId(getApplication()).getUserId();                Log.i(TAG, "getParams: " + userId);                locModel = locTable.getPositionById(id);                params.put("user_id", String.valueOf(locModel.getUserId()));                params.put("date", locModel.getDate());                params.put("latitude", String.valueOf(locModel.getLatitude()));                params.put("longitude", String.valueOf(locModel.getLongitude()));                params.put("altitude", String.valueOf(locModel.getAltitude()));                params.put("provider", locModel.getProvider());                params.put("accuracy", String.valueOf(locModel.getAccuracy()));                params.put("local_id", String.valueOf(locModel.getId()));                params.put("device_id", locModel.getUserDeviceId());                //  params.put("version_name", position.getVersionName());                //Log.i(TAG, "LocationDetaisl: UserId: " + userId + "\ndate: " + position.getDate() + "\nlatitude: " + position.getLatitude() + "\nDevice Id: " + position.getUserDeviceId());                return params;            }        };        int socketTimeout = 30000; // 30 seconds. You can change it        RetryPolicy policy = new DefaultRetryPolicy(                socketTimeout,                DefaultRetryPolicy.DEFAULT_MAX_RETRIES,                DefaultRetryPolicy.DEFAULT_BACKOFF_MULT        );        stringRequest.setRetryPolicy(policy);        requestQueue = Volley.newRequestQueue(this);        requestQueue.add(stringRequest);    }}